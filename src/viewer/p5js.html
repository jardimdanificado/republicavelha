<!DOCTYPE html>
<html>

<head>
	<style>
		html, body 
		{
			border: 0px; 
			margin: 0px;
			padding: 0px;
			height: 100%;
			width: 100%;
			font-family:'Lucida Console', monospace;
			font-size: 80%;
			white-space: nowrap;
		}
		canvas
		{
			display: block;
			position: absolute;
			left: 0;
			top: 0;
		}
	</style>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>republicavelha</title>
	<link rel="shortcut icon" type="image/x-icon" href="../../favicon.ico">
</head>

<body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js""></script>
	<script>
		var started = false;
		var world, fns = [];
		var kmera = 
		{
			position:{},
			target:{},
			map:{},
			currentPosition:3,
		}

		var getMap = async (fn,args)=>
		{
			return fn.apply(this,args);
		}

		function cyclePosition(kmera,suboradd=0)
		{
			const posit = 
			[
				{
					position:
					{
						x:0,
						y:0
					},
					target:
					{
						x:kmera.map.length*5,
						y:kmera.map[0].length*5
					}
				},
				{
					position:
					{
						x:0,
						y:kmera.map[0].length*5
					},
					target:
					{
						x:kmera.map.length*5,
						y:0
					}
				},
				{
					position:
					{
						x:kmera.map.length*5,
						y:kmera.map[0].length*5
					},
					target:
					{
						x:0,
						y:0
					}
				},
				{
					position:
					{
						x:kmera.map.length*5,
						y:0
					},
					target:
					{
						x:0,
						y:kmera.map[0].length*5
					}
				},
			]
			if(suboradd == 'sub'||suboradd == 0)
			{
				if(kmera.currentPosition==0)
					kmera.currentPosition = 3;
				else
					kmera.currentPosition--;
			}
			else
			{
				if(kmera.currentPosition==3)
					kmera.currentPosition = 0;
				else
					kmera.currentPosition++;
			}
			kmera.position.x = posit[kmera.currentPosition].position.x;
			kmera.position.y = posit[kmera.currentPosition].position.y;

			kmera.target.x = posit[kmera.currentPosition].target.x;
			kmera.target.y = posit[kmera.currentPosition].target.y;
			return kmera;
		}

		function keyPressed() 
		{
			if (keyCode === LEFT_ARROW) 
			{
				kmera = cyclePosition(kmera,'sub');
			}
			else if (keyCode === RIGHT_ARROW) 
			{
				kmera = cyclePosition(kmera,'add');
			}
			else if (keyCode === 33) //PGUP
			{
				kmera.position.z += 50;
			}
			else if (keyCode === 34) //PGDOWN
			{
				kmera.position.z -= 50;
			}
			else if (keyCode === UP_ARROW) 
			{
				kmera.target.z += 50;
			}
			else if (keyCode === DOWN_ARROW) 
			{
				kmera.target.z -= 50;
			}
		}

		async function setup() 
		{
			setAttributes('antialias', true);
			createCanvas(windowWidth, windowHeight, WEBGL);
			frameRate(1);
			angleMode(DEGREES);
			var {main} = await import("../../index.mjs");
			var {ScaleTo} = await import("../republicavelha/util.mjs");
			fns.ScaleTo = ScaleTo;
			world = await getMap(main,[{w:64,h:16},4,1,1,true,true],world);
			
			kmera.map = world.map.collision;
			kmera.position = 
			{
				x:kmera.map.length*5,
				y:kmera.map[0].length*5,
				z:kmera.map[0][0].length*5+100
			}
			kmera.target = 
			{
				x:0,
				y:0,
				z:(kmera.map[0][0].length*-5)+100
			}
			started = true;
			strokeWeight(1)
			return;
		}

		function draw() 
		{
			if(started==true)
			{
				camera(
					kmera.position.x,//x 2dhorizozntal
					kmera.position.y,//y 2dvertical
					kmera.position.z,//z altura
					kmera.target.x,//taget x
					kmera.target.y,//target y
					kmera.target.z,//target z
					0,//direction up on z
					0,
					-1
				);
				clear();
				background(0,100,125);
				
				world.map.heightmap.map(
					(value,x)=>
					{
						value.map(
							(value,y)=>
							{
								push();
								translate(x*5, y*5,world.map.heightmap[x][y]*5);
								let sfactor = fns.ScaleTo(world.map.heightmap[x][y],0,255);
								fill(
									sfactor*2,
									255-sfactor*0.7,
									0
								)
								box(5, 5, 5);
								pop();
							}
						)
					}
				)
			}
		}

	</script>
</body>

</html>