<!DOCTYPE html>
<html>

<head>
	<style>
		html, body 
		{
			border: 0px; 
			margin: 0px;
			padding: 0px;
			height: 100%;
			width: 100%;
			font-family:'Lucida Console', monospace;
			font-size: 80%;
			white-space: nowrap;
		}
		canvas
		{
			display: block;
			position: absolute;
			left: 0;
			top: 0;
		}
	</style>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>republicavelha</title>
	<link rel="shortcut icon" type="image/x-icon" href="../../favicon.ico">
</head>

<body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js""></script>
	<script>
		var stroked = true;
		var world, fns = [],min,max;

		var kmera =
		{
			position:{},
			target:{},
			map:{},
			currentPosition:0,
			theme:0,
		}

		function getColorTheme(currentTheme,sfactor)
		{
			let letra = (['rgb', 'rbg', 'grb', 'gbr', 'brg', 'bgr'])[currentTheme].split('');
			let rgb = 
			{
				r:sfactor*30,
				g:255-sfactor*15,
				b:0
			};
			return[rgb[letra[0]],rgb[letra[1]],rgb[letra[2]]];
		}

		var getMap = async (fn,args)=>
		{
			return fn.apply(this,args);
		}

		function cyclePosition(kmera,suboradd=0)
		{
			const posit = 
			[
				{
					position:
					{
						x:0,
						y:0
					},
					target:
					{
						x:kmera.map.length*5,
						y:kmera.map[0].length*5
					}
				},
				{
					position:
					{
						x:0,
						y:kmera.map[0].length*5/2
					},
					target:
					{
						x:kmera.map.length*5,
						y:kmera.map.length*5/2
					}
				},
				{
					position:
					{
						x:0,
						y:kmera.map[0].length*5
					},
					target:
					{
						x:kmera.map.length*5,
						y:0
					}
				},
				{
					position:
					{
						x:kmera.map.length*5/2,
						y:kmera.map[0].length*5
					},
					target:
					{
						x:kmera.map.length*5/2,
						y:0
					}
				},
				{
					position:
					{
						x:kmera.map.length*5,
						y:kmera.map[0].length*5
					},
					target:
					{
						x:0,
						y:0
					}
				},
				{
					position:
					{
						x:kmera.map.length*5,
						y:kmera.map[0].length*5/2
					},
					target:
					{
						x:0,
						y:kmera.map[0].length*5/2
					}
				},
				{
					position:
					{
						x:kmera.map.length*5,
						y:0
					},
					target:
					{
						x:0,
						y:kmera.map[0].length*5
					}
				},
				{
					position:
					{
						x:kmera.map.length*5/2,
						y:0
					},
					target:
					{
						x:kmera.map.length*5/2,
						y:kmera.map[0].length*5
					}
				},
			]
			if(suboradd == 'sub'||suboradd == 0)
			{
				if(kmera.currentPosition==0)
					kmera.currentPosition = 7;
				else
					kmera.currentPosition--;
			}
			else
			{
				if(kmera.currentPosition==7)
					kmera.currentPosition = 0;
				else
					kmera.currentPosition++;
			}
			kmera.position.x = posit[kmera.currentPosition].position.x;
			kmera.position.y = posit[kmera.currentPosition].position.y;

			kmera.target.x = posit[kmera.currentPosition].target.x;
			kmera.target.y = posit[kmera.currentPosition].target.y;
			return kmera;
		}

		function keyPressed() 
		{
			if (keyCode === LEFT_ARROW) 
			{
				kmera = cyclePosition(kmera,'sub');
			}
			else if (keyCode === RIGHT_ARROW) 
			{
				kmera = cyclePosition(kmera,'add');
			}
			else if (keyCode === 33) //PGUP
			{
				kmera.position.z += 50;
			}
			else if (keyCode === 34) //PGDOWN
			{
				kmera.position.z -= 50;
			}
			else if (keyCode === 35) //END
			{
				kmera.theme = (kmera.theme==0)?5:kmera.theme-1;
			}
			else if (keyCode === 36) //HOME
			{
				kmera.theme = (kmera.theme==5)?0:kmera.theme+1;
			}
			else if (keyCode === UP_ARROW) 
			{
				kmera.target.z += 50;
			}
			else if (keyCode === DOWN_ARROW) 
			{
				kmera.target.z -= 50;
			}
			else if (keyCode === 45)//insert
			{
				stroked = (stroked)?false:true;
				(stroked)?stroke(0):noStroke();
			}
			redraw();
		}

		async function setup() 
		{
			setAttributes('antialias', false);
			createCanvas(windowWidth, windowHeight, WEBGL);
			//frameRate(1);
			angleMode(DEGREES);
			
			var {main} = await import("../../index.mjs");
			var {ScaleTo,findMinMax,regraDeTres,getUniqueValues} = await import("../republicavelha/util.mjs");
			fns.ScaleTo = ScaleTo;
			fns.findMinMax = findMinMax;
			fns.regraDeTres = regraDeTres;
			fns.getUniqueValues = getUniqueValues;
			world = await getMap(main,[{w:64,h:64},2,1,1,true,true]);
			
			kmera.map = world.map.collision;
			var {min,max} = fns.findMinMax(kmera.map);
			kmera.max = max;
			kmera.min = min;
			kmera.position = 
			{
				x:kmera.map.length*5,
				y:kmera.map[0].length*5,
				z:kmera.map[0][0].length*5+100
			}
			kmera.target = 
			{
				x:0,
				y:0,
				z:(kmera.map[0][0].length*-5)+100
			}
			noLoop();
		}

		function draw() 
		{
			if(typeof world !== 'undefined')
			{	camera(
					kmera.position.x,//x 2dhorizozntal
					kmera.position.y,//y 2dvertical
					kmera.position.z,//z altura
					kmera.target.x,//taget x
					kmera.target.y,//target y
					kmera.target.z,//target z
					0,//direction up on z
					0,
					-1
				);
				clear();
				background(0,100,125);
				
				
				let extra = 0;
				if(kmera.max<kmera.map[0][0].length/2)
					extra = kmera.map[0][0].length/8;
				else if(kmera.max>kmera.map[0][0].length/2)
					extra = -kmera.map[0][0].length/8;
				
				let colors = fns.getUniqueValues(world.map.heightmap).map((elm)=>
				{
					return ({id:elm,value:fns.regraDeTres(kmera.max,255,fns.ScaleTo(elm-kmera.min,0,kmera.max))});
				}).map((elm)=>
				{
					return({id:elm.id,value:getColorTheme(kmera.theme,elm.value+extra)});
				})
				world.map.heightmap.map(
					(value,x)=>
					{
						value.map(
							(value,y)=>
							{
								push();
								translate(x*5, y*5,world.map.heightmap[x][y]*5);
								fill.apply(this,colors.find((elm)=> {return elm.id === world.map.heightmap[x][y]}).value);
								box(5, 5, 5);
								pop();
							}
						)
					}
				)
			}
		}

	</script>
</body>

</html>